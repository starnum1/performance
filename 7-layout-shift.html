<!DOCTYPE html>
<html>
<head>
  <title>é—®é¢˜8: å¸ƒå±€åç§» (Layout Shift / CLS)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    h1 { color: #2c3e50; }

    .demo-section {
      margin: 30px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .demo-section h3 {
      margin-top: 0;
      color: #e74c3c;
    }

    button {
      padding: 10px 20px;
      margin: 10px 5px;
      font-size: 16px;
      cursor: pointer;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
    }

    button:hover {
      background: #2980b9;
    }

    .good-example {
      border-left: 4px solid #27ae60;
    }

    .good-example h3 {
      color: #27ae60;
    }

    .content {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      line-height: 1.6;
    }

    /* åç¤ºä¾‹ï¼šæ²¡æœ‰é¢„ç•™ç©ºé—´çš„å›¾ç‰‡ */
    .bad-image {
      width: 100%;
      height: auto;
    }

    /* å¥½ç¤ºä¾‹ï¼šä½¿ç”¨ aspect-ratio é¢„ç•™ç©ºé—´ */
    .good-image-container {
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #e0e0e0;
      position: relative;
    }

    .good-image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* åŠ¨æ€æ’å…¥çš„å¹¿å‘Š */
    .ad-banner {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 30px;
      text-align: center;
      margin: 15px 0;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
    }

    /* é¢„ç•™å¹¿å‘Šä½ */
    .ad-placeholder {
      min-height: 100px;
      background: #f0f0f0;
      border: 2px dashed #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      margin: 15px 0;
      border-radius: 8px;
    }

    .metrics {
      background: #fff3cd;
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }

    .shift-indicator {
      background: #ffe6e6;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      color: #c0392b;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>é—®é¢˜8: å¸ƒå±€åç§» (Layout Shift / CLS)</h1>

  <div class="metrics">
    <h3>ğŸ“Š ä»€ä¹ˆæ˜¯ CLS (Cumulative Layout Shift)?</h3>
    <p><strong>ç´¯ç§¯å¸ƒå±€åç§»</strong> - è¡¡é‡é¡µé¢è§†è§‰ç¨³å®šæ€§çš„æŒ‡æ ‡</p>
    <ul>
      <li><strong>è‰¯å¥½ï¼š</strong> CLS < 0.1</li>
      <li><strong>éœ€è¦æ”¹è¿›ï¼š</strong> 0.1 â‰¤ CLS â‰¤ 0.25</li>
      <li><strong>å·®ï¼š</strong> CLS > 0.25</li>
    </ul>
    <p><strong>å¦‚ä½•è§‚å¯Ÿï¼š</strong>æ‰“å¼€ DevTools Performance é¢æ¿ï¼Œå½•åˆ¶åæŸ¥çœ‹ "Layout Shifts" æ³³é“</p>
  </div>

  <!-- é—®é¢˜1: æ²¡æœ‰å°ºå¯¸çš„å›¾ç‰‡ -->
  <div class="demo-section">
    <h3>âŒ é—®é¢˜1: å›¾ç‰‡æ²¡æœ‰é¢„ç•™ç©ºé—´</h3>
    <p>å›¾ç‰‡åŠ è½½å‰æ²¡æœ‰å ä½ï¼ŒåŠ è½½åä¼šæŠŠä¸‹é¢çš„å†…å®¹æŒ¤ä¸‹å»</p>
    <button onclick="loadBadImage()">åŠ è½½å›¾ç‰‡ï¼ˆä¼šå¯¼è‡´å¸ƒå±€åç§»ï¼‰</button>
    <button onclick="resetBadImage()">é‡ç½®</button>
    
    <div id="badImageContainer"></div>
    
    <div class="content">
      <p>ğŸ‘† ç‚¹å‡»æŒ‰é’®åï¼Œè¿™æ®µæ–‡å­—ä¼šè¢«çªç„¶å‡ºç°çš„å›¾ç‰‡æŒ¤ä¸‹å»ï¼</p>
      <p>è¿™å°±æ˜¯å…¸å‹çš„å¸ƒå±€åç§»ï¼Œç”¨æˆ·ä½“éªŒå¾ˆå·®ã€‚</p>
    </div>
  </div>

  <!-- è§£å†³æ–¹æ¡ˆ1 -->
  <div class="demo-section good-example">
    <h3>âœ… è§£å†³æ–¹æ¡ˆ1: ä½¿ç”¨ aspect-ratio é¢„ç•™ç©ºé—´</h3>
    <p>æå‰é¢„ç•™å›¾ç‰‡ç©ºé—´ï¼Œé¿å…åŠ è½½åçš„å¸ƒå±€åç§»</p>
    <button onclick="loadGoodImage()">åŠ è½½å›¾ç‰‡ï¼ˆæ— å¸ƒå±€åç§»ï¼‰</button>
    <button onclick="resetGoodImage()">é‡ç½®</button>
    
    <div id="goodImageContainer"></div>
    
    <div class="content">
      <p>ğŸ‘† è¿™æ®µæ–‡å­—ä¸ä¼šè¢«æŒ¤ä¸‹å»ï¼Œå› ä¸ºå›¾ç‰‡ç©ºé—´å·²ç»é¢„ç•™å¥½äº†ï¼</p>
    </div>
  </div>

  <!-- é—®é¢˜2: åŠ¨æ€æ’å…¥çš„å†…å®¹ -->
  <div class="demo-section">
    <h3>âŒ é—®é¢˜2: åŠ¨æ€æ’å…¥å¹¿å‘Š/å†…å®¹</h3>
    <p>åœ¨ç°æœ‰å†…å®¹ä¸Šæ–¹çªç„¶æ’å…¥å¹¿å‘Šæˆ–é€šçŸ¥</p>
    <button onclick="insertAd()">æ’å…¥å¹¿å‘Šï¼ˆä¼šå¯¼è‡´å¸ƒå±€åç§»ï¼‰</button>
    <button onclick="resetAd()">é‡ç½®</button>
    
    <div id="adContainer"></div>
    
    <div class="content">
      <p>ğŸ‘† ç‚¹å‡»æŒ‰é’®åï¼Œå¹¿å‘Šä¼šçªç„¶å‡ºç°ï¼ŒæŠŠè¿™æ®µæ–‡å­—æŒ¤ä¸‹å»ï¼</p>
      <p>è¿™æ˜¯ç½‘é¡µä¸­æœ€å¸¸è§çš„å¸ƒå±€åç§»é—®é¢˜ä¹‹ä¸€ã€‚</p>
    </div>
  </div>

  <!-- è§£å†³æ–¹æ¡ˆ2 -->
  <div class="demo-section good-example">
    <h3>âœ… è§£å†³æ–¹æ¡ˆ2: é¢„ç•™å¹¿å‘Šä½</h3>
    <p>æå‰é¢„ç•™å¹¿å‘Šç©ºé—´ï¼Œæˆ–è€…åœ¨åº•éƒ¨æ’å…¥</p>
    <button onclick="insertAdGood()">æ’å…¥å¹¿å‘Šï¼ˆæ— å¸ƒå±€åç§»ï¼‰</button>
    <button onclick="resetAdGood()">é‡ç½®</button>
    
    <div id="adContainerGood">
      <div class="ad-placeholder">å¹¿å‘Šä½é¢„ç•™</div>
    </div>
    
    <div class="content">
      <p>ğŸ‘† è¿™æ®µæ–‡å­—ä¸ä¼šç§»åŠ¨ï¼Œå› ä¸ºå¹¿å‘Šä½å·²ç»é¢„ç•™å¥½äº†ï¼</p>
    </div>
  </div>

  <!-- é—®é¢˜3: Web Fonts å¯¼è‡´çš„åç§» -->
  <div class="demo-section">
    <h3>âŒ é—®é¢˜3: Web Fonts åŠ è½½å¯¼è‡´æ–‡å­—è·³åŠ¨</h3>
    <p>è‡ªå®šä¹‰å­—ä½“åŠ è½½åï¼Œæ–‡å­—å¤§å°å˜åŒ–å¯¼è‡´å¸ƒå±€åç§»</p>
    <button onclick="loadWebFont()">åŠ è½½è‡ªå®šä¹‰å­—ä½“ï¼ˆä¼šå¯¼è‡´åç§»ï¼‰</button>
    <button onclick="resetWebFont()">é‡ç½®</button>
    
    <div id="fontContainer" style="font-size: 24px; line-height: 1.5;">
      <p>è¿™æ˜¯ä¸€æ®µä½¿ç”¨è‡ªå®šä¹‰å­—ä½“çš„æ–‡å­—ã€‚åŠ è½½å‰åå­—ä½“å¤§å°å¯èƒ½ä¸åŒã€‚</p>
    </div>
    
    <div class="content">
      <p>ğŸ‘† å­—ä½“åŠ è½½åï¼Œæ–‡å­—é«˜åº¦å˜åŒ–ä¼šå½±å“ä¸‹æ–¹å†…å®¹ä½ç½®</p>
    </div>
  </div>

  <!-- é—®é¢˜4: æ²¡æœ‰é«˜åº¦çš„å®¹å™¨ -->
  <div class="demo-section">
    <h3>âŒ é—®é¢˜4: åŠ¨æ€å†…å®¹æ²¡æœ‰æœ€å°é«˜åº¦</h3>
    <p>å¼‚æ­¥åŠ è½½çš„å†…å®¹æ²¡æœ‰é¢„ç•™ç©ºé—´</p>
    <button onclick="loadDynamicContent()">åŠ è½½å†…å®¹ï¼ˆä¼šå¯¼è‡´åç§»ï¼‰</button>
    <button onclick="resetDynamicContent()">é‡ç½®</button>
    
    <div id="dynamicContainer" style="background: #e8f5e9; padding: 10px; border-radius: 4px;"></div>
    
    <div class="content">
      <p>ğŸ‘† åŠ¨æ€å†…å®¹åŠ è½½åä¼šæŠŠè¿™æ®µæ–‡å­—æŒ¤ä¸‹å»</p>
    </div>
  </div>

  <!-- è§£å†³æ–¹æ¡ˆ4 -->
  <div class="demo-section good-example">
    <h3>âœ… è§£å†³æ–¹æ¡ˆ4: è®¾ç½®æœ€å°é«˜åº¦æˆ–éª¨æ¶å±</h3>
    <p>ä¸ºåŠ¨æ€å†…å®¹è®¾ç½® min-height æˆ–ä½¿ç”¨éª¨æ¶å±</p>
    <button onclick="loadDynamicContentGood()">åŠ è½½å†…å®¹ï¼ˆæ— åç§»ï¼‰</button>
    <button onclick="resetDynamicContentGood()">é‡ç½®</button>
    
    <div id="dynamicContainerGood" style="background: #e8f5e9; padding: 10px; border-radius: 4px; min-height: 100px; display: flex; align-items: center; justify-content: center; color: #999;">
      åŠ è½½ä¸­...
    </div>
    
    <div class="content">
      <p>ğŸ‘† è¿™æ®µæ–‡å­—ä¸ä¼šç§»åŠ¨ï¼Œå› ä¸ºå®¹å™¨æœ‰æœ€å°é«˜åº¦</p>
    </div>
  </div>

  <div class="metrics">
    <h3>ğŸ”§ é˜²æ­¢å¸ƒå±€åç§»çš„æœ€ä½³å®è·µ</h3>
    <ol>
      <li><strong>å›¾ç‰‡/è§†é¢‘ï¼š</strong>å§‹ç»ˆè®¾ç½® width å’Œ height å±æ€§ï¼Œæˆ–ä½¿ç”¨ aspect-ratio</li>
      <li><strong>å¹¿å‘Š/åµŒå…¥å†…å®¹ï¼š</strong>é¢„ç•™å›ºå®šç©ºé—´ï¼Œé¿å…åœ¨ç°æœ‰å†…å®¹ä¸Šæ–¹æ’å…¥</li>
      <li><strong>Web Fontsï¼š</strong>ä½¿ç”¨ font-display: optional æˆ– font-display: swap</li>
      <li><strong>åŠ¨æ€å†…å®¹ï¼š</strong>è®¾ç½® min-height æˆ–ä½¿ç”¨éª¨æ¶å±</li>
      <li><strong>åŠ¨ç”»ï¼š</strong>ä½¿ç”¨ transform è€Œä¸æ˜¯æ”¹å˜ top/left/width/height</li>
    </ol>
  </div>

  <script>
    // é—®é¢˜1: æ²¡æœ‰å°ºå¯¸çš„å›¾ç‰‡
    function loadBadImage() {
      const container = document.getElementById('badImageContainer');
      container.innerHTML = '<img src="https://picsum.photos/800/450?random=' + Date.now() + '" class="bad-image" alt="ç¤ºä¾‹å›¾ç‰‡">';
    }

    function resetBadImage() {
      document.getElementById('badImageContainer').innerHTML = '';
    }

    // è§£å†³æ–¹æ¡ˆ1: é¢„ç•™ç©ºé—´çš„å›¾ç‰‡
    function loadGoodImage() {
      const container = document.getElementById('goodImageContainer');
      container.innerHTML = `
        <div class="good-image-container">
          <img src="https://picsum.photos/800/450?random=${Date.now()}" alt="ç¤ºä¾‹å›¾ç‰‡">
        </div>
      `;
    }

    function resetGoodImage() {
      document.getElementById('goodImageContainer').innerHTML = '';
    }

    // é—®é¢˜2: åŠ¨æ€æ’å…¥å¹¿å‘Š
    function insertAd() {
      const container = document.getElementById('adContainer');
      container.innerHTML = '<div class="ad-banner">ğŸ‰ é™æ—¶ä¼˜æƒ ï¼ç«‹å³è´­ä¹°äº«å—8æŠ˜ä¼˜æƒ ï¼</div>';
    }

    function resetAd() {
      document.getElementById('adContainer').innerHTML = '';
    }

    // è§£å†³æ–¹æ¡ˆ2: é¢„ç•™å¹¿å‘Šä½
    function insertAdGood() {
      const container = document.getElementById('adContainerGood');
      container.innerHTML = '<div class="ad-banner">ğŸ‰ é™æ—¶ä¼˜æƒ ï¼ç«‹å³è´­ä¹°äº«å—8æŠ˜ä¼˜æƒ ï¼</div>';
    }

    function resetAdGood() {
      document.getElementById('adContainerGood').innerHTML = '<div class="ad-placeholder">å¹¿å‘Šä½é¢„ç•™</div>';
    }

    // é—®é¢˜3: Web Fonts
    function loadWebFont() {
      const container = document.getElementById('fontContainer');
      container.style.fontFamily = 'Georgia, serif';
      container.style.fontSize = '28px';
    }

    function resetWebFont() {
      const container = document.getElementById('fontContainer');
      container.style.fontFamily = 'Arial, sans-serif';
      container.style.fontSize = '24px';
    }

    // é—®é¢˜4: åŠ¨æ€å†…å®¹
    function loadDynamicContent() {
      const container = document.getElementById('dynamicContainer');
      container.innerHTML = `
        <h4>åŠ¨æ€åŠ è½½çš„å†…å®¹</h4>
        <p>è¿™æ˜¯ä¸€æ®µå¼‚æ­¥åŠ è½½çš„å†…å®¹ï¼ŒåŒ…å«å¤šè¡Œæ–‡å­—ã€‚</p>
        <p>ç”±äºæ²¡æœ‰é¢„ç•™ç©ºé—´ï¼ŒåŠ è½½åä¼šå¯¼è‡´ä¸‹æ–¹å†…å®¹ç§»åŠ¨ã€‚</p>
      `;
    }

    function resetDynamicContent() {
      document.getElementById('dynamicContainer').innerHTML = '';
    }

    // è§£å†³æ–¹æ¡ˆ4: æœ‰æœ€å°é«˜åº¦çš„åŠ¨æ€å†…å®¹
    function loadDynamicContentGood() {
      const container = document.getElementById('dynamicContainerGood');
      container.innerHTML = `
        <div>
          <h4 style="margin-top: 0;">åŠ¨æ€åŠ è½½çš„å†…å®¹</h4>
          <p>è¿™æ˜¯ä¸€æ®µå¼‚æ­¥åŠ è½½çš„å†…å®¹ï¼ŒåŒ…å«å¤šè¡Œæ–‡å­—ã€‚</p>
          <p style="margin-bottom: 0;">ç”±äºé¢„ç•™äº†æœ€å°é«˜åº¦ï¼ŒåŠ è½½åä¸ä¼šå¯¼è‡´å¸ƒå±€åç§»ã€‚</p>
        </div>
      `;
      container.style.justifyContent = 'flex-start';
      container.style.color = 'inherit';
    }

    function resetDynamicContentGood() {
      const container = document.getElementById('dynamicContainerGood');
      container.innerHTML = 'åŠ è½½ä¸­...';
      container.style.justifyContent = 'center';
      container.style.color = '#999';
    }

    // ç›‘æµ‹å¸ƒå±€åç§»
    if ('PerformanceObserver' in window) {
      let clsScore = 0;
      
      const observer = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
          if (!entry.hadRecentInput) {
            clsScore += entry.value;
            console.log('å¸ƒå±€åç§»æ£€æµ‹:', {
              value: entry.value,
              ç´¯è®¡CLS: clsScore.toFixed(4),
              å½±å“å…ƒç´ : entry.sources
            });
          }
        }
      });
      
      observer.observe({ entryTypes: ['layout-shift'] });
    }
  </script>
</body>
</html>
