<!DOCTYPE html>
<html>
<head>
  <title>问题6: 绘制性能问题</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    .demo-container { display: flex; gap: 20px; margin: 20px 0; }
    .demo-box { 
      width: 400px; 
      height: 400px; 
      border: 2px solid #ccc; 
      position: relative; 
      overflow: hidden;
      background: #f5f5f5;
    }
    .ball { 
      width: 30px; 
      height: 30px; 
      border-radius: 50%; 
      position: absolute;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .bad-ball { background: linear-gradient(45deg, #e74c3c, #c0392b); }
    .good-ball { 
      background: linear-gradient(45deg, #3498db, #2980b9); 
      will-change: transform;
    }
    #output { margin-top: 20px; padding: 10px; background: #eee; }
    .fps-counter { 
      position: absolute; 
      top: 5px; 
      right: 5px; 
      background: rgba(0,0,0,0.7); 
      color: white; 
      padding: 5px 10px; 
      font-size: 14px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>问题6: 绘制性能问题</h1>
  <p>50个小球同时动画，观察性能差异。开启 Paint flashing 看重绘区域。</p>
  
  <button id="badBtn">坏方式：top/left（触发重排+重绘）</button>
  <button id="goodBtn">好方式：transform（GPU加速）</button>
  <button id="stopBtn">停止动画</button>
  
  <div class="demo-container">
    <div class="demo-box" id="badBox">
      <span class="fps-counter" id="badFps">FPS: --</span>
      <p style="position: absolute; bottom: 5px; left: 5px; margin: 0; font-size: 12px; color: #666;">坏方式: top/left</p>
    </div>
    <div class="demo-box" id="goodBox">
      <span class="fps-counter" id="goodFps">FPS: --</span>
      <p style="position: absolute; bottom: 5px; left: 5px; margin: 0; font-size: 12px; color: #666;">好方式: transform</p>
    </div>
  </div>
  
  <div id="output">点击按钮开始动画</div>

  <script>
    const badBox = document.getElementById('badBox');
    const goodBox = document.getElementById('goodBox');
    const output = document.getElementById('output');
    const badFpsEl = document.getElementById('badFps');
    const goodFpsEl = document.getElementById('goodFps');
    
    const BALL_COUNT = 50;
    let badBalls = [];
    let goodBalls = [];
    let animationId = null;
    let startTime = null;
    
    // FPS 计算 - 分别为两个动画计数
    let badFrameCount = 0;
    let badLastFpsTime = 0;
    let goodFrameCount = 0;
    let goodLastFpsTime = 0;

    // 创建小球
    function createBalls() {
      // 清空
      badBox.querySelectorAll('.ball').forEach(b => b.remove());
      goodBox.querySelectorAll('.ball').forEach(b => b.remove());
      badBalls = [];
      goodBalls = [];
      
      for (let i = 0; i < BALL_COUNT; i++) {
        // 坏方式的球
        const badBall = document.createElement('div');
        badBall.className = 'ball bad-ball';
        badBox.appendChild(badBall);
        badBalls.push({
          el: badBall,
          speed: 0.5 + Math.random() * 2,
          offset: Math.random() * Math.PI * 2
        });
        
        // 好方式的球
        const goodBall = document.createElement('div');
        goodBall.className = 'ball good-ball';
        goodBox.appendChild(goodBall);
        goodBalls.push({
          el: goodBall,
          speed: badBalls[i].speed,  // 相同速度
          offset: badBalls[i].offset  // 相同偏移
        });
      }
    }

    function stopAnimation() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }

    // 坏示例：使用 top/left
    document.getElementById('badBtn').addEventListener('click', function() {
      stopAnimation();
      createBalls();
      startTime = performance.now();
      badLastFpsTime = startTime;
      badFrameCount = 0;
      output.innerHTML = '<span style="color: red;">坏方式运行中...</span> 使用 top/left，每帧触发 Layout + Paint';
      
      function animate(currentTime) {
        const elapsed = currentTime - startTime;
        
        // 更新所有坏球 - 使用 top/left
        badBalls.forEach(ball => {
          const x = (Math.sin(elapsed / 1000 * ball.speed + ball.offset) + 1) * 175;
          const y = (Math.cos(elapsed / 1000 * ball.speed + ball.offset) + 1) * 175;
          ball.el.style.left = x + 'px';
          ball.el.style.top = y + 'px';
        });
        
        // 计算 FPS
        badFrameCount++;
        if (currentTime - badLastFpsTime >= 1000) {
          badFpsEl.textContent = `FPS: ${badFrameCount}`;
          badFrameCount = 0;
          badLastFpsTime = currentTime;
        }
        
        animationId = requestAnimationFrame(animate);
      }
      
      animationId = requestAnimationFrame(animate);
    });

    // 好示例：使用 transform
    document.getElementById('goodBtn').addEventListener('click', function() {
      stopAnimation();
      createBalls();
      startTime = performance.now();
      goodLastFpsTime = startTime;
      goodFrameCount = 0;
      output.innerHTML = '<span style="color: green;">好方式运行中...</span> 使用 transform，只触发 Composite（GPU）';
      
      function animate(currentTime) {
        const elapsed = currentTime - startTime;
        
        // 更新所有好球 - 使用 transform
        goodBalls.forEach(ball => {
          const x = (Math.sin(elapsed / 1000 * ball.speed + ball.offset) + 1) * 175;
          const y = (Math.cos(elapsed / 1000 * ball.speed + ball.offset) + 1) * 175;
          ball.el.style.transform = `translate(${x}px, ${y}px)`;
        });
        
        // 计算 FPS
        goodFrameCount++;
        if (currentTime - goodLastFpsTime >= 1000) {
          goodFpsEl.textContent = `FPS: ${goodFrameCount}`;
          goodFrameCount = 0;
          goodLastFpsTime = currentTime;
        }
        
        animationId = requestAnimationFrame(animate);
      }
      
      animationId = requestAnimationFrame(animate);
    });

    document.getElementById('stopBtn').addEventListener('click', function() {
      stopAnimation();
      badFpsEl.textContent = 'FPS: --';
      goodFpsEl.textContent = 'FPS: --';
      output.innerHTML = '动画已停止';
    });
  </script>
</body>
</html>
